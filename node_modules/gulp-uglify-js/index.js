var fs = require("fs");
var parser = require("uglify-js").parser;
var uglify = require("uglify-js").uglify;

function scanDir(rootPath) {
    // read dir
    fs.readdir(rootPath, function(dirErr, files){
        if( !dirErr ) {
            files.forEach(function(fileName){
                // current file path
                var tmpPath = rootPath + "/" + fileName;
                // get file status
                fs.stat(tmpPath, function(statErr, stat){
                    if( statErr ){
                        console.log("stat error:" + statErr);
                    }else if( stat.isDirectory() ){
                    // is a folder
                        scanDir(tmpPath);
                    }
                    else {
                        console.log(fileName)
                        // is js file
                        if(fileName.match(/\.js$/i)){
                            compressFile(tmpPath);
                        }
                    }
                });
            });
        }
        else
            console.log("dir error");
    })
}
function compressFile(path){
    buildOne(path,path);
}
function buildOne(flieIn, fileOut) {
    console.log('buildOne')
    var origCode = fs.readFileSync(flieIn, 'utf8');
    var ast = parser.parse(origCode);
    ast = uglify.ast_mangle(ast);
    ast = uglify.ast_squeeze(ast);
    var finalCode = uglify.gen_code(ast);
    console.log("compressed:" + fileOut);
    fs.writeFileSync(fileOut, finalCode, 'utf8');
}

module.exports = scanDir
